{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="empty-cart" class="hidden text-center py-16">
            <h1 class="text-3xl md:text-4xl uppercase tracking-wider mb-4 font-bold">
                Your Cart is Empty
            </h1>
            <p class="text-neutral-600 mb-8">
                Looks like you haven't added anything to your cart yet.
            </p>
            <a href="{% url 'shop' %}"
                class="inline-block px-8 py-3 bg-black text-white hover:bg-neutral-800 transition-colors">
                Continue Shopping
            </a>
        </div>

        <div id="cart-content" class="hidden">
            <h1 class="text-3xl md:text-4xl uppercase tracking-wider mb-8 font-bold">
                Shopping Cart
            </h1>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Cart Items -->
                <div class="lg:col-span-2 space-y-6" id="cart-items-container">
                    <!-- Items will be injected here by JS -->
                </div>

                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="border border-neutral-200 p-6 sticky top-24">
                        <h2 class="text-xl uppercase tracking-wider mb-6 font-semibold">
                            Order Summary
                        </h2>

                        <!-- Coupon -->
                        <div class="mb-6">
                            <label class="text-sm uppercase tracking-wider mb-2 block font-medium">
                                Coupon Code
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="coupon-code" placeholder="Enter code"
                                    class="w-full px-4 py-3 border border-neutral-300 focus:outline-none focus:border-black rounded-lg" />
                                <button onclick="applyCoupon()"
                                    class="px-4 py-2 bg-neutral-100 hover:bg-neutral-200 transition-colors">
                                    <i data-lucide="tag" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p class="text-xs text-neutral-500 mt-2">
                                Try: GRAD20 or WELCOME10
                            </p>
                        </div>

                        <!-- Price Breakdown -->
                        <div class="space-y-3 mb-6 pb-6 border-b border-neutral-200">
                            <div class="flex justify-between">
                                <span class="text-neutral-600">Subtotal</span>
                                <span id="subtotal-display">₹0.00</span>
                            </div>
                            <div id="discount-row" class="flex justify-between text-green-600 hidden">
                                <span>Discount (<span id="discount-percent">0</span>%)</span>
                                <span>-₹<span id="discount-amount">0.00</span></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-neutral-600">Shipping</span>
                                <span id="shipping-display">₹0.00</span>
                            </div>
                            <p id="free-shipping-msg" class="text-xs text-neutral-500 hidden">
                                Add ₹<span id="amount-to-free">0.00</span> more for free shipping!
                            </p>
                        </div>

                        <!-- Total -->
                        <div class="flex justify-between text-xl mb-6 font-bold">
                            <span>Total</span>
                            <span id="total-display">₹0.00</span>
                        </div>

                        <!-- Checkout Button -->
                        <a href="{% url 'checkout' %}"
                            class="block w-full bg-black text-white py-3 hover:bg-neutral-800 transition-colors mb-3 text-center">
                            Proceed to Checkout
                        </a>
                        <a href="{% url 'shop' %}"
                            class="block w-full border border-neutral-300 py-3 hover:bg-neutral-100 transition-colors text-center">
                            Continue Shopping
                        </a>

                        <!-- Trust Badges -->
                        <div class="mt-6 pt-6 border-t border-neutral-200 space-y-2">
                            <p class="text-xs text-neutral-600 flex items-center space-x-2">
                                <span>✓</span>
                                <span>Secure checkout</span>
                            </p>
                            <p class="text-xs text-neutral-600 flex items-center space-x-2">
                                <span>✓</span>
                                <span>Free returns within 30 days</span>
                            </p>
                            <p class="text-xs text-neutral-600 flex items-center space-x-2">
                                <span>✓</span>
                                <span>2-5 business days delivery</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    let discount = 0;

    function loadCart() {
        cart = JSON.parse(localStorage.getItem("cart") || "[]");
        renderCart();
    }

    function renderCart() {
        if (cart.length === 0) {
            document.getElementById('empty-cart').classList.remove('hidden');
            document.getElementById('cart-content').classList.add('hidden');
            return;
        }

        document.getElementById('empty-cart').classList.add('hidden');
        document.getElementById('cart-content').classList.remove('hidden');

        const container = document.getElementById('cart-items-container');
        container.innerHTML = '';

        cart.forEach((item, index) => {
            const itemHtml = `
                <div class="flex flex-col sm:flex-row gap-4 p-4 border border-neutral-200">
                    <img
                        src="${item.image || item.images[0]}"
                        alt="${item.name}"
                        class="w-24 h-32 sm:w-32 sm:h-32 object-cover bg-neutral-100 flex-shrink-0"
                    />
                    <div class="flex-1">
                        <div class="flex justify-between mb-2">
                            <div>
                                <h3 class="text-lg mb-1 font-semibold">${item.name}</h3>
                                <p class="text-sm text-neutral-600">
                                    Size: ${item.selectedSize}
                                </p>
                            </div>
                            <button
                                onclick="removeItem(${index})"
                                class="p-2 hover:bg-neutral-100 rounded transition-colors h-fit"
                            >
                                <i data-lucide="trash-2" class="w-5 h-5 text-neutral-600"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-3">
                                <button
                                    onclick="updateQuantity(${index}, ${item.quantity - 1})"
                                    class="p-1 border border-neutral-300 hover:bg-neutral-100"
                                >
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <span class="w-8 text-center">${item.quantity}</span>
                                <button
                                    onclick="updateQuantity(${index}, ${item.quantity + 1})"
                                    class="p-1 border border-neutral-300 hover:bg-neutral-100"
                                >
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <span class="text-lg font-semibold">
                                ₹${(item.price * item.quantity).toFixed(2)}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += itemHtml;
        });

        lucide.createIcons();
        updateTotals();
    }

    function updateQuantity(index, newQuantity) {
        if (newQuantity < 1) return;
        cart[index].quantity = newQuantity;
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
    }

    function applyCoupon() {
        const code = document.getElementById('coupon-code').value.toUpperCase();
        if (code === "GRAD20") {
            discount = 20;
            showToast("Coupon applied! 20% discount");
        } else if (code === "WELCOME10") {
            discount = 10;
            showToast("Coupon applied! 10% discount");
        } else {
            showToast("Invalid coupon code", "error");
            return;
        }
        updateTotals();
    }

    function updateTotals() {
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountAmount = (subtotal * discount) / 100;
        const shipping = subtotal > 1000 ? 0 : 100;
        const total = subtotal - discountAmount + shipping;

        document.getElementById('subtotal-display').innerText = '₹' + subtotal.toFixed(2);

        if (discount > 0) {
            document.getElementById('discount-row').classList.remove('hidden');
            document.getElementById('discount-percent').innerText = discount;
            document.getElementById('discount-amount').innerText = discountAmount.toFixed(2);
        }

        if (shipping === 0) {
            document.getElementById('shipping-display').innerHTML = '<span class="text-green-600">Free</span>';
            document.getElementById('free-shipping-msg').classList.add('hidden');
        } else {
            document.getElementById('shipping-display').innerText = '₹' + shipping.toFixed(2);
            if (subtotal < 1000) {
                document.getElementById('free-shipping-msg').classList.remove('hidden');
                document.getElementById('amount-to-free').innerText = (1000 - subtotal).toFixed(2);
            }
        }

        document.getElementById('total-display').innerText = '₹' + total.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', loadCart);
</script>
{% endblock %}